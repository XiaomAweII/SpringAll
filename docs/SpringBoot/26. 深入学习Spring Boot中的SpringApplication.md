<font style="color:rgb(76, 73, 72);">在Spring Boot的入口类中，我们通常是通过调用</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplication</font>_`<font style="color:rgb(76, 73, 72);">的run方法来启动Spring Boot项目。这节我们来深入学习下SpringApplication的一些细节。</font>

<h2 id="自定义SpringApplication"><font style="color:rgb(76, 73, 72);">自定义SpringApplication</font></h2>
<font style="color:rgb(76, 73, 72);">默认的我们都是直接通过</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplication</font>_`<font style="color:rgb(76, 73, 72);">的run方法来直接启动Spring Boot，其实我们可以通过一些API来调整某些行为。</font>

<h3 id="通过SpringApplication-API调整"><font style="color:rgb(76, 73, 72);">通过SpringApplication API调整</font></h3>
<font style="color:rgb(76, 73, 72);">我们新建一个SpringBoot项目，Spring Boot版本为2.1.0.RELEASE，</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">artifactId</font>_`<font style="color:rgb(76, 73, 72);">为SpringApplication，并引入</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">spring-boot-starter-web</font>_`<font style="color:rgb(76, 73, 72);">依赖。项目结构如下所示:</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713521413-803b2395-444c-40bf-a436-f509da85c483.png)

<font style="color:rgb(76, 73, 72);">我们将入口类的代码改为：</font>

```java
SpringApplication application = new SpringApplication(DemoApplication.class);
application.setBannerMode(Banner.Mode.OFF);
application.setWebApplicationType(WebApplicationType.NONE);
application.setAdditionalProfiles("dev");
application.run(args);
```

<font style="color:rgb(76, 73, 72);">通过调用</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplication</font>_`<font style="color:rgb(76, 73, 72);">的方法，我们关闭了Banner的打印，设置应用环境为非WEB应用，profiles指定为dev。除此之外，</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplication</font>_`<font style="color:rgb(76, 73, 72);">还包含了许多别的方法，具体可以查看源码或者官方文档：</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713526636-68852f34-f396-44c0-b8ea-eddb60511451.png)

<h3 id="通过SpringApplicationBuilder-API调整"><font style="color:rgb(76, 73, 72);">通过SpringApplicationBuilder API调整</font></h3>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationBuilder</font>_`<font style="color:rgb(76, 73, 72);">提供了Fluent API，可以实现链式调用，下面的代码和上面的效果一致，但在编写上较为方便：</font>

```java
new SpringApplicationBuilder(DemoApplication.class)
        .bannerMode(Banner.Mode.OFF)
        .web(WebApplicationType.NONE)
        .profiles("dev")
        .run(args);
```

<h2 id="SpringApplication准备阶段"><font style="color:rgb(76, 73, 72);">SpringApplication准备阶段</font></h2>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplication</font>_`<font style="color:rgb(76, 73, 72);">的生命周期阶段大致可以分为准备阶段和运行阶段。</font>

<font style="color:rgb(76, 73, 72);">我们通过源码来查看</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplication</font>_`<font style="color:rgb(76, 73, 72);">的有参构造器：</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713521464-498df679-9a1a-43d7-9046-d7274705a937.png)

<font style="color:rgb(76, 73, 72);">通过有参构造器里的代码我们可以将</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplication</font>_`<font style="color:rgb(76, 73, 72);">的准备阶段分为以下几个步骤：</font>

<h3 id="配置源"><font style="color:rgb(76, 73, 72);">配置源</font></h3>
<font style="color:rgb(76, 73, 72);">构造器中</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">this.primarySources = new LinkedHashSet<>(Arrays.asList(primarySources));</font>_`<font style="color:rgb(76, 73, 72);">这行代码用于加载我们配置的Spring Boot Bean源。通常我们使用</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplication</font>_`<font style="color:rgb(76, 73, 72);">或者</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationBuilder</font>_`<font style="color:rgb(76, 73, 72);">的构造器来直接指定源。</font>

<font style="color:rgb(76, 73, 72);">所谓的Spring Boot Bean源指的是某个被</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">@SpringBootApplication</font>_`<font style="color:rgb(76, 73, 72);">注解标注的类，比如入口类：</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713521372-ebfdd4ba-cf89-4f5c-9c1a-5aee8870e615.png)

<font style="color:rgb(76, 73, 72);">我们也可以将上面的代码改为下面这种方式：</font>

```java
public class DemoApplication {

    public static void main(String[] args) {
        SpringApplication application = new SpringApplication(ApplicationResource.class);
        application.run(args);
    }

    @SpringBootApplication
    public static class ApplicationResource {

    }
}
```

<font style="color:rgb(76, 73, 72);">这样也是可行的。查看</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplication</font>_`<font style="color:rgb(76, 73, 72);">的单个参数构造器：</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713526380-b3f52e1b-a303-48e4-af02-2e8c1192cdb8.png)

<font style="color:rgb(76, 73, 72);">说明我们除了配置单个源外，还可以配置多个源。</font>

<h3 id="推断应用类型"><font style="color:rgb(76, 73, 72);">推断应用类型</font></h3>
<font style="color:rgb(76, 73, 72);">构造器中这行</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">this.webApplicationType = WebApplicationType.deduceFromClasspath();</font>_`<font style="color:rgb(76, 73, 72);">代码用于推断当前Spring Boot应用类型。</font>

<font style="color:rgb(76, 73, 72);">Spring Boot 2.0后，应用可以分为下面三种类型：</font>

1. `_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">WebApplicationType.NONE</font>_`<font style="color:rgb(76, 73, 72);">：非WEB类型；</font>
2. `_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">WebApplicationType.REACTIVE</font>_`<font style="color:rgb(76, 73, 72);">：Web Reactive类型；</font>
3. `_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">WebApplicationType.SERVLET</font>_`<font style="color:rgb(76, 73, 72);">：Web Servlet类型。</font>

`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">WebApplicationType.deduceFromClasspath()</font>_`<font style="color:rgb(76, 73, 72);">方法根据当前应用ClassPath中是否存在相关的实现类来判断应用类型到底是哪个，</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">deduceFromClasspath</font>_`<font style="color:rgb(76, 73, 72);">方法的源码如下所示:</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713528723-7c391d67-3911-4550-b5de-f36aa4beb168.png)

<font style="color:rgb(76, 73, 72);">我们也可以直接通过</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplication</font>_`<font style="color:rgb(76, 73, 72);">的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">setWebApplicationType</font>_`<font style="color:rgb(76, 73, 72);">方法或者</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationBuilder</font>_`<font style="color:rgb(76, 73, 72);">的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">web</font>_`<font style="color:rgb(76, 73, 72);">方法来指定当前应用的类型。</font>

<h3 id="加载应用上下文初始器"><font style="color:rgb(76, 73, 72);">加载应用上下文初始器</font></h3>
<font style="color:rgb(76, 73, 72);">接着下一行代码</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));</font>_`<font style="color:rgb(76, 73, 72);">用于加载应用上下文初始器</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationContextInitializer</font>_`<font style="color:rgb(76, 73, 72);">。</font>

`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">getSpringFactoriesInstances</font>_`<font style="color:rgb(76, 73, 72);">方法的源码如下所示：</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713528575-1cdddc65-6f74-41ef-83ac-36e73a09dcb6.png)

<font style="color:rgb(76, 73, 72);">上面代码利用Spring工厂加载机制，实例化</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationContextInitializer</font>_`<font style="color:rgb(76, 73, 72);">实现类，并进行排序。</font>

<font style="color:rgb(76, 73, 72);">所以我们可以通过实现</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationContextInitializer</font>_`<font style="color:rgb(76, 73, 72);">接口用于在Spring Boot应用初始化之前执行一些自定义操作。</font>

<font style="color:rgb(76, 73, 72);">举个例子，在</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">com.example.demo</font>_`<font style="color:rgb(76, 73, 72);">下新建</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">initializer</font>_`<font style="color:rgb(76, 73, 72);">包，然后创建一个</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">HelloApplicationContextInitializer</font>_`<font style="color:rgb(76, 73, 72);">类，实现</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationContextInitializer</font>_`<font style="color:rgb(76, 73, 72);">接口：</font>

```java
@Order(Ordered.HIGHEST_PRECEDENCE)
public class HelloApplicationContextInitializer implements ApplicationContextInitializer {
    @Override
    public void initialize(ConfigurableApplicationContext applicationContext) {
        System.out.println("ConfigurableApplicationContext.id - " + applicationContext.getId());
    }
}
```

<font style="color:rgb(76, 73, 72);">上面代码中实现了initialize方法，并且使用</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">@Order</font>_`<font style="color:rgb(76, 73, 72);">注解指定优先级。其中</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">Ordered.HIGHEST_PRECEDENCE</font>_`<font style="color:rgb(76, 73, 72);">等于</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">Integer.MIN_VALUE</font>_`<font style="color:rgb(76, 73, 72);">，</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">Ordered.LOWEST_PRECEDENCE</font>_`<font style="color:rgb(76, 73, 72);">等于</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">Integer.MAX_VALUE</font>_`<font style="color:rgb(76, 73, 72);">。所以数值越小，优先级越高。</font>

<font style="color:rgb(76, 73, 72);">除了使用</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">@Order</font>_`<font style="color:rgb(76, 73, 72);">注解来指定优先级外，我们也可以通过实现</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">org.springframework.core.Ordered</font>_`<font style="color:rgb(76, 73, 72);">接口的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">getOrder</font>_`<font style="color:rgb(76, 73, 72);">方法来指定优先级。</font>

<font style="color:rgb(76, 73, 72);">接着我们来创建一个优先级比</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">HelloApplicationContextInitializer</font>_`<font style="color:rgb(76, 73, 72);">低的Initializer ——</font><font style="color:rgb(76, 73, 72);"> </font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">AfterHelloApplicationContextInitializer</font>_`<font style="color:rgb(76, 73, 72);">：</font>

```java
public class AfterHelloApplicationContextInitializer implements ApplicationContextInitializer, Ordered {
    @Override
    public void initialize(ConfigurableApplicationContext applicationContext) {
        System.out.println("AfterHelloApplicationContextInitializer: " + applicationContext.getId());
    }

    @Override
    public int getOrder() {
        return Ordered.LOWEST_PRECEDENCE;
    }
}
```

<font style="color:rgb(76, 73, 72);">上面通过</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">getOrder</font>_`<font style="color:rgb(76, 73, 72);">方法来指定了优先级为最低优先级。</font>

<font style="color:rgb(76, 73, 72);">创建好后，我们还需在工厂配置文件里配置这两个实现类。在resources目录下新建META-INF目录，并创建spring.factories文件：</font>

```properties
# Initializers
org.springframework.context.ApplicationContextInitializer=\
com.example.demo.initializer.HelloApplicationContextInitializer,\
com.example.demo.initializer.AfterHelloApplicationContextInitializer
```

<font style="color:rgb(76, 73, 72);">这时候，启动Spring Boot项目，会发现控制台在打印Banner后就执行了这两个初始化器，并且</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">HelloApplicationContextInitializer</font>_`<font style="color:rgb(76, 73, 72);">的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">initialize</font>_`<font style="color:rgb(76, 73, 72);">方法执行时机先于</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">AfterHelloApplicationContextInitializer</font>_`<font style="color:rgb(76, 73, 72);">的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">initialize</font>_`<font style="color:rgb(76, 73, 72);">方法：</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713528583-f2d6f1e6-6bb0-4a54-85d4-e56a605fcb1b.png)

<h3 id="加载应用事件监听器"><font style="color:rgb(76, 73, 72);">加载应用事件监听器</font></h3>
<font style="color:rgb(76, 73, 72);">在加载完应用上下文初始器后，下一行的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));</font>_`<font style="color:rgb(76, 73, 72);">代码加载了应用事件监听器。与加载事件上下文初始器类似，Spring Boot也是通过Spring的工厂方法来实例化</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationListener</font>_`<font style="color:rgb(76, 73, 72);">的实现类，并进行排序。</font>

<font style="color:rgb(76, 73, 72);">既然是事件监听，那么其可以监听什么事件呢？其监听的是</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationEvent</font>_`<font style="color:rgb(76, 73, 72);">接口的实现类，我们查看一下都有哪些事件实现了这个接口：</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713529144-4b346c73-2d07-40a8-9e5f-6e3de6e8f7dd.png)

<font style="color:rgb(76, 73, 72);">这里我们以</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ContextClosedEvent</font>_`<font style="color:rgb(76, 73, 72);">为例子来编写自定义的应用事件监听器，监听Spring上下文关闭事件。</font>

<font style="color:rgb(76, 73, 72);">在</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">com.example.demo</font>_`<font style="color:rgb(76, 73, 72);">下新建</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">listener</font>_`<font style="color:rgb(76, 73, 72);">包，然后创建一个</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ContextClosedEventListener</font>_`<font style="color:rgb(76, 73, 72);">类，实现</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationListener</font>_`<font style="color:rgb(76, 73, 72);">接口：</font>

```java
@Order(Ordered.HIGHEST_PRECEDENCE)
public class ContextClosedEventListener implements ApplicationListener<ContextClosedEvent> {

    @Override
    public void onApplicationEvent(ContextClosedEvent event) {
        System.out.println("ContextClosedEvent: " + event.getApplicationContext().getId());
    }
}
```

<font style="color:rgb(76, 73, 72);">上面代码实现了对</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ContextClosedEvent</font>_`<font style="color:rgb(76, 73, 72);">事件的监听，并且分配了最高优先级。</font>

<font style="color:rgb(76, 73, 72);">接着创建一个优先级比</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ContextClosedEventListener</font>_`<font style="color:rgb(76, 73, 72);">低的监听器</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">AfterContextClosedEventListener</font>_`<font style="color:rgb(76, 73, 72);">：</font>

```java
public class AfterContextClosedEventListener implements ApplicationListener<ContextClosedEvent>, Ordered {
    @Override
    public void onApplicationEvent(ContextClosedEvent event) {
        System.out.println("AfterContextClosedEventr: " + event.getApplicationContext().getId());
    }

    @Override
    public int getOrder() {
        return Ordered.HIGHEST_PRECEDENCE + 1;
    }
}
```

<font style="color:rgb(76, 73, 72);">最后，别忘了在Spring工厂配置文件里进行配置：</font>

```properties
# Application Listeners
org.springframework.context.ApplicationListener=\
com.example.demo.listener.ContextClosedEventListener,\
com.example.demo.listener.AfterContextClosedEventListener
```

<font style="color:rgb(76, 73, 72);">在Spring Boot入口类中将环境指定为非WEB环境（这样在启动后应用会马上关闭）:</font>

```java
new SpringApplicationBuilder(DemoApplication.class)
                .web(WebApplicationType.NONE)
                .run(args);
```

<font style="color:rgb(76, 73, 72);">运行Spring Boot入口类，控制台输出如下：</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713528762-1980918a-ece4-4eec-8dc9-e240f0e0267a.png)

<h3 id="推断入口类"><font style="color:rgb(76, 73, 72);">推断入口类</font></h3>
<font style="color:rgb(76, 73, 72);">接着构造器里的代码下一行</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">this.mainApplicationClass = deduceMainApplicationClass();</font>_`<font style="color:rgb(76, 73, 72);">用于推断运行Spring Boot应用的入口类。查看</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">deduceMainApplicationClass</font>_`<font style="color:rgb(76, 73, 72);">方法源码：</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713529533-bd70650c-cf4d-429e-897b-091d6a918bcd.png)

<font style="color:rgb(76, 73, 72);">代码主要逻辑是根据Main线程执行堆栈判断实际的入口类。</font>

<font style="color:rgb(76, 73, 72);">准备阶段介绍完毕后，接下来开始介绍运行阶段。</font>

<h2 id="SpringApplication运行阶段"><font style="color:rgb(76, 73, 72);">SpringApplication运行阶段</font></h2>
<font style="color:rgb(76, 73, 72);">SpringApplication的运行阶段对应</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplication</font>_`<font style="color:rgb(76, 73, 72);">的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法，我们查看其源码：</font>

```java
public ConfigurableApplicationContext run(String... args) {
    StopWatch stopWatch = new StopWatch();
    stopWatch.start();
    ConfigurableApplicationContext context = null;
    Collection<SpringBootExceptionReporter> exceptionReporters = new ArrayList<>();
    configureHeadlessProperty();
    SpringApplicationRunListeners listeners = getRunListeners(args);
    listeners.starting();
    try {
        ApplicationArguments applicationArguments = new DefaultApplicationArguments(
            args);
        ConfigurableEnvironment environment = prepareEnvironment(listeners,
                                                                 applicationArguments);
        configureIgnoreBeanInfo(environment);
        Banner printedBanner = printBanner(environment);
        context = createApplicationContext();
        exceptionReporters = getSpringFactoriesInstances(
            SpringBootExceptionReporter.class,
            new Class[]{ConfigurableApplicationContext.class}, context);
        prepareContext(context, environment, listeners, applicationArguments,
                       printedBanner);
        refreshContext(context);
        afterRefresh(context, applicationArguments);
        stopWatch.stop();
        if (this.logStartupInfo) {
            new StartupInfoLogger(this.mainApplicationClass)
            .logStarted(getApplicationLog(), stopWatch);
        }
        listeners.started(context);
        callRunners(context, applicationArguments);
    } catch (Throwable ex) {
        handleRunFailure(context, ex, exceptionReporters, listeners);
        throw new IllegalStateException(ex);
    }

    try {
        listeners.running(context);
    } catch (Throwable ex) {
        handleRunFailure(context, ex, exceptionReporters, null);
        throw new IllegalStateException(ex);
    }
    return context;
}
```

<font style="color:rgb(76, 73, 72);">运行阶段大致可以分为下面这几个过程：</font>

<h3 id="开启时间监听"><font style="color:rgb(76, 73, 72);">开启时间监听</font></h3>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法开头的这两行代码用于开启时间监听：</font>

```java
StopWatch stopWatch = new StopWatch();
stopWatch.start();
```

<font style="color:rgb(76, 73, 72);">上面代码用于开启Spring Boot应用启动时间监听，配合下面的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">stopWatch.stop();</font>_`<font style="color:rgb(76, 73, 72);">便可以计算出完整的启动时间。</font>

<h3 id="开启运行监听器"><font style="color:rgb(76, 73, 72);">开启运行监听器</font></h3>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法的这几行代码用于加载Spring应用运行监听器（SpringApplicationRunListener）：</font>

```java
SpringApplicationRunListeners listeners = getRunListeners(args);
listeners.started();
```

`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">getRunListeners</font>_`<font style="color:rgb(76, 73, 72);">方法源码：</font>

```java
private SpringApplicationRunListeners getRunListeners(String[] args) {
    Class<?>[] types = new Class<?>[] { SpringApplication.class, String[].class };
    return new SpringApplicationRunListeners(logger, getSpringFactoriesInstances(
        SpringApplicationRunListener.class, types, this, args));
}
```

<font style="color:rgb(76, 73, 72);">上面代码通过</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringFactoriesLoader</font>_`<font style="color:rgb(76, 73, 72);">检索META-INF/spring.factories找到声明的所有</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationRunListener</font>_`<font style="color:rgb(76, 73, 72);">的实现类并将其实例化，然后装配到</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">List<SpringApplicationRunListener></font>_`<font style="color:rgb(76, 73, 72);">运行监听器集合中。</font>

`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">listeners.started();</font>_`<font style="color:rgb(76, 73, 72);">用于遍历运行监听器集合中的所有</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationRunListener</font>_`<font style="color:rgb(76, 73, 72);">的实现类，并逐一调用它们的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">starting</font>_`<font style="color:rgb(76, 73, 72);">方法，广播Spring Boot应用要开始启动了。</font>

<font style="color:rgb(76, 73, 72);">在Spring Boot中</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationRunListener</font>_`<font style="color:rgb(76, 73, 72);">接口用于监听整个Spring Boot应用生命周期，其代码如下所示：</font>

```java
public interface SpringApplicationRunListener {
    void starting();

    void environmentPrepared(ConfigurableEnvironment environment);

    void contextPrepared(ConfigurableApplicationContext context);

    void contextLoaded(ConfigurableApplicationContext context);

    void started(ConfigurableApplicationContext context);

    void running(ConfigurableApplicationContext context);

    void failed(ConfigurableApplicationContext context, Throwable exception);
}
```

<font style="color:rgb(76, 73, 72);">这些方法对应着Spring Boot应用生命周期的各个阶段：</font>

| **<font style="color:rgb(76, 73, 72);">方法名称</font>** | **<font style="color:rgb(76, 73, 72);">对应生命周期</font>** | **<font style="color:rgb(76, 73, 72);">Spring Boot起始版本</font>** |
| :--- | :--- | :--- |
| <font style="color:rgb(76, 73, 72);">starting()</font> | <font style="color:rgb(76, 73, 72);">Spring 应用刚启动</font> | <font style="color:rgb(76, 73, 72);">1.0</font> |
| <font style="color:rgb(76, 73, 72);">environmentPrepared(ConfigurableEnvironment)</font> | <font style="color:rgb(76, 73, 72);">ConfigurableEnvironment 准备完毕，允许将其调整</font> | <font style="color:rgb(76, 73, 72);">1.0</font> |
| <font style="color:rgb(76, 73, 72);">contextPrepared(ConfigurableApplicationContext)</font> | <font style="color:rgb(76, 73, 72);">ConfigurableApplicationContext 准备完毕，允许将其调整</font> | <font style="color:rgb(76, 73, 72);">1.0</font> |
| <font style="color:rgb(76, 73, 72);">contextLoaded(ConfigurableApplicationContext)</font> | <font style="color:rgb(76, 73, 72);">ConfigurableApplicationContext 已装载，但仍未启动</font> | <font style="color:rgb(76, 73, 72);">1.0</font> |
| <font style="color:rgb(76, 73, 72);">started(ConfigurableApplicationContext)</font> | <font style="color:rgb(76, 73, 72);">ConfigurableApplicationContext 已启动，此时 Spring Bean 已初始化完成</font> | <font style="color:rgb(76, 73, 72);">2.0</font> |
| <font style="color:rgb(76, 73, 72);">running(ConfigurableApplicationContext)</font> | <font style="color:rgb(76, 73, 72);">Spring 应用正在运行</font> | <font style="color:rgb(76, 73, 72);">2.0</font> |
| <font style="color:rgb(76, 73, 72);">failed(ConfigurableApplicationContext,Throwable)</font> | <font style="color:rgb(76, 73, 72);">Spring 应用运行失败</font> | <font style="color:rgb(76, 73, 72);">2.0</font> |


<font style="color:rgb(76, 73, 72);">我们在</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">com.example.demo.linstener</font>_`<font style="color:rgb(76, 73, 72);">下自定义一个</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationRunListener</font>_`<font style="color:rgb(76, 73, 72);">接口实现类</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">HelloSpringApplicationRunListener</font>_`<font style="color:rgb(76, 73, 72);">：</font>

```java
public class HelloApplicationRunListener implements SpringApplicationRunListener {

    public HelloApplicationRunListener(SpringApplication application, String[] args) {
    }

    @Override
    public void starting() {
        System.out.println("HelloApplicationRunListener starting......");
    }

    @Override
    public void environmentPrepared(ConfigurableEnvironment environment) {

    }

    @Override
    public void contextPrepared(ConfigurableApplicationContext context) {

    }

    @Override
    public void contextLoaded(ConfigurableApplicationContext context) {

    }

    @Override
    public void started(ConfigurableApplicationContext context) {

    }

    @Override
    public void running(ConfigurableApplicationContext context) {

    }

    @Override
    public void failed(ConfigurableApplicationContext context, Throwable exception) {

    }
}
```

<font style="color:rgb(76, 73, 72);">通过这个实现类，我们可以在Spring Boot应用刚启动的时候在控制台输出</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">HelloApplicationRunListener starting......</font>_`<font style="color:rgb(76, 73, 72);">。</font>

<font style="color:rgb(76, 73, 72);">因为其基于Spring的工厂方法来实现，所以我们需要在spring.factories文件里配置这个实现类:</font>

```properties
# Run Listeners
org.springframework.boot.SpringApplicationRunListener=\
com.example.demo.run.HelloApplicationRunListener
```

<font style="color:rgb(76, 73, 72);">启动Spring Boot应用便可以在控制台看到如下输出了：</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713529703-a17e3f97-4501-4e05-8590-57da0d904c22.png)

<h3 id="创建-Environment"><font style="color:rgb(76, 73, 72);">创建 Environment</font></h3>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法中的这行代码用于创建并配置当前SpringBoot应用将要使用的Environment（包括配置要使用的PropertySource以及Profile）：</font>

```java
ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);
```

<font style="color:rgb(76, 73, 72);">我们已经在准备阶段里推断出了应用类型，这里只要根据相应的应用类型来创建相应的应用环境即可，类型和环境对应关系如下：</font>

+ <font style="color:rgb(76, 73, 72);">Web Reactive： StandardReactiveWebEnvironment</font>
+ <font style="color:rgb(76, 73, 72);">Web Servlet： StandardServletEnvironment</font>
+ <font style="color:rgb(76, 73, 72);">非 Web： StandardEnvironment</font>

<font style="color:rgb(76, 73, 72);">在</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">prepareEnvironment</font>_`<font style="color:rgb(76, 73, 72);">方法中会执行</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">listeners.environmentPrepared(environment);</font>_`<font style="color:rgb(76, 73, 72);">，用于遍历调用所有</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationRunListener</font>_`<font style="color:rgb(76, 73, 72);">实现类的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">environmentPrepared()</font>_`<font style="color:rgb(76, 73, 72);">方法，广播Environment准备完毕。</font>

<h3 id="是否打印Banner"><font style="color:rgb(76, 73, 72);">是否打印Banner</font></h3>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法中的这行代码会根据我们的配置来决定是否打印Banner：</font>

```java
Banner printedBanner = printBanner(environment);
```

<h3 id="创建Context"><font style="color:rgb(76, 73, 72);">创建Context</font></h3>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法中的这行代码用于创建</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationContext</font>_`<font style="color:rgb(76, 73, 72);">：</font>

```java
context = createApplicationContext();
```

<font style="color:rgb(76, 73, 72);">不同的环境对应不同的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationContext</font>_`<font style="color:rgb(76, 73, 72);">：</font>

+ <font style="color:rgb(76, 73, 72);">Web Reactive： AnnotationConfigReactiveWebServerApplicationContext</font>
+ <font style="color:rgb(76, 73, 72);">Web Servlet： AnnotationConfigServletWebServerApplicationContext</font>
+ <font style="color:rgb(76, 73, 72);">非 Web： AnnotationConfigApplicationContext</font>

<h3 id="装配Context"><font style="color:rgb(76, 73, 72);">装配Context</font></h3>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法中的这行代码用于装配Context：</font>

```java
prepareContext(context, environment, listeners, applicationArguments, printedBanner);
```

<font style="color:rgb(76, 73, 72);">方法</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">prepareContext</font>_`<font style="color:rgb(76, 73, 72);">的源码如下所示:</font>

```java
private void prepareContext(ConfigurableApplicationContext context,
                            ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,
                            ApplicationArguments applicationArguments, Banner printedBanner) {
    context.setEnvironment(environment);
    postProcessApplicationContext(context);
    applyInitializers(context);
    listeners.contextPrepared(context);
    if (this.logStartupInfo) {
        logStartupInfo(context.getParent() == null);
        logStartupProfileInfo(context);
    }
    // Add boot specific singleton beans
    ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();
    beanFactory.registerSingleton("springApplicationArguments", applicationArguments);
    if (printedBanner != null) {
        beanFactory.registerSingleton("springBootBanner", printedBanner);
    }
    if (beanFactory instanceof DefaultListableBeanFactory) {
        ((DefaultListableBeanFactory) beanFactory)
        .setAllowBeanDefinitionOverriding(this.allowBeanDefinitionOverriding);
    }
    // Load the sources
    Set<Object> sources = getAllSources();
    Assert.notEmpty(sources, "Sources must not be empty");
    load(context, sources.toArray(new Object[0]));
    listeners.contextLoaded(context);
}
```

`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">prepareContext</font>_`<font style="color:rgb(76, 73, 72);">方法开头为</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationContext</font>_`<font style="color:rgb(76, 73, 72);">加载了environment，之后通过</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">applyInitializers</font>_`<font style="color:rgb(76, 73, 72);">方法逐个执行</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationContextInitializer</font>_`<font style="color:rgb(76, 73, 72);">的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">initialize</font>_`<font style="color:rgb(76, 73, 72);">方法来进一步封装</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationContext</font>_`<font style="color:rgb(76, 73, 72);">，并调用所有的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationRunListener</font>_`<font style="color:rgb(76, 73, 72);">实现类的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">contextPrepared</font>_`<font style="color:rgb(76, 73, 72);">方法，广播ApplicationContext已经准备完毕了。</font>

<font style="color:rgb(76, 73, 72);">之后初始化IOC容器，并调用</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationRunListener</font>_`<font style="color:rgb(76, 73, 72);">实现类的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">contextLoaded</font>_`<font style="color:rgb(76, 73, 72);">方法，广播</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationContext</font>_`<font style="color:rgb(76, 73, 72);">加载完成，这里就包括通过</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">@EnableAutoConfiguration</font>_`<font style="color:rgb(76, 73, 72);">导入的各种自动配置类。</font>

<h3 id="Refresh-Context"><font style="color:rgb(76, 73, 72);">Refresh Context</font></h3>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法中的这行代码用于初始化所有自动配置类，并调用</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationContext</font>_`<font style="color:rgb(76, 73, 72);">的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">refresh</font>_`<font style="color:rgb(76, 73, 72);">方法：</font>

```java
refreshContext(context);
```

<h3 id="广播应用已启动"><font style="color:rgb(76, 73, 72);">广播应用已启动</font></h3>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法中的这行代码用于广播Spring Boot应用已启动：</font>

```java
listeners.started(context);
```

`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">started</font>_`<font style="color:rgb(76, 73, 72);">方法会调用所有的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationRunListener</font>_`<font style="color:rgb(76, 73, 72);">的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">finished</font>_`<font style="color:rgb(76, 73, 72);">方法，广播SpringBoot应用已经成功启动。</font>

<h3 id="执行Runner"><font style="color:rgb(76, 73, 72);">执行Runner</font></h3>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法中的这行代码</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">callRunners(context, applicationArguments);</font>_`<font style="color:rgb(76, 73, 72);">遍历所有</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationRunner</font>_`<font style="color:rgb(76, 73, 72);">和</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">CommandLineRunner</font>_`<font style="color:rgb(76, 73, 72);">的实现类，并执行其</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法。我们可以实现自己的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationRunner</font>_`<font style="color:rgb(76, 73, 72);">或者</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">CommandLineRunner</font>_`<font style="color:rgb(76, 73, 72);">，来对Spring Boot的启动过程进行扩展。</font>

<font style="color:rgb(76, 73, 72);">我们在</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">com.example.demo</font>_`<font style="color:rgb(76, 73, 72);">下新建</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">runner</font>_`<font style="color:rgb(76, 73, 72);">包，然后创建一个</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationRunner</font>_`<font style="color:rgb(76, 73, 72);">的实现类</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">HelloApplicationRunner</font>_`<font style="color:rgb(76, 73, 72);">：</font>

```java
@Component
public class HelloApplicationRunner implements ApplicationRunner {
    @Override
    public void run(ApplicationArguments args) {
        System.out.println("HelloApplicationRunner: hello spring boot");
    }
}
```

<font style="color:rgb(76, 73, 72);">这里我们需要将</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">HelloApplicationRunner</font>_`<font style="color:rgb(76, 73, 72);">使用</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">@Component</font>_`<font style="color:rgb(76, 73, 72);">注解标注，让其注册到IOC容器中。</font>

<font style="color:rgb(76, 73, 72);">然后再创建一个</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">CommandLineRunner</font>_`<font style="color:rgb(76, 73, 72);">的实现类</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">HelloCommandLineRunner</font>_`<font style="color:rgb(76, 73, 72);">：</font>

```java
@Component
public class HelloCommandLineRunner implements CommandLineRunner {
    @Override
    public void run(String... args) {
        System.out.println("HelloCommandLineRunner: hello spring boot");
    }
}
```

<font style="color:rgb(76, 73, 72);">启动Spring Boot应用，便可以在应用刚启动好后看到如下输出：</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734713529598-d31c5cac-4c6a-46f2-870b-97cfd6ace86f.png)

<h3 id="广播应用运行中"><font style="color:rgb(76, 73, 72);">广播应用运行中</font></h3>
`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法中的这行代码</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">listeners.running(context);</font>_`<font style="color:rgb(76, 73, 72);">用于调用</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationRunListener</font>_`<font style="color:rgb(76, 73, 72);">的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">running</font>_`<font style="color:rgb(76, 73, 72);">方法，广播Spring Boot应用正在运行中。</font>

<font style="color:rgb(76, 73, 72);">当</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">run</font>_`<font style="color:rgb(76, 73, 72);">方法运行出现异常时，便会调用</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">handleRunFailure</font>_`<font style="color:rgb(76, 73, 72);">方法来处理异常，该方法里会通过</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">listeners.failed(context, exception);</font>_`<font style="color:rgb(76, 73, 72);">来调用</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SpringApplicationRunListener</font>_`<font style="color:rgb(76, 73, 72);">的</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">failed</font>_`<font style="color:rgb(76, 73, 72);">方法，广播应用启动失败，并将异常扩散出去。</font>

<font style="color:rgb(76, 73, 72);">上面所有的广播事件都是使用Spring的应用事件广播器接口</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">ApplicationEventMulticaster</font>_`<font style="color:rgb(76, 73, 72);">的实现类</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">SimpleApplicationEventMulticaster</font>_`<font style="color:rgb(76, 73, 72);">来进行广播的。</font>

<font style="color:rgb(102, 102, 102);">源码链接：</font>[<font style="color:rgb(102, 102, 102);">https://github.com/wuyouzhuguli/SpringAll/tree/master/45.Spring-Boot-SpringApplication</font>](https://github.com/wuyouzhuguli/SpringAll/tree/master/45.Spring-Boot-SpringApplication)

