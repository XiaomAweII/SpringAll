<font style="color:rgb(76, 73, 72);">åœ¨Springæ¡†æ¶ä¸­ï¼Œä½¿ç”¨AOPé…åˆè‡ªå®šä¹‰æ³¨è§£å¯ä»¥æ–¹ä¾¿çš„å®ç°ç”¨æˆ·æ“ä½œçš„ç›‘æ§ã€‚é¦–å…ˆæ­å»ºä¸€ä¸ªåŸºæœ¬çš„Spring Boot Webç¯å¢ƒ</font>[<font style="color:rgb(76, 73, 72);">å¼€å¯Spring Boot</font>](https://mrbird.cc/%E5%BC%80%E5%90%AFSpring-Boot.html)<font style="color:rgb(76, 73, 72);">ï¼Œç„¶åå¼•å…¥å¿…è¦ä¾èµ–ï¼š</font>

| ```plain 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 ```  | ```plain <dependency>     <groupId>org.springframework.boot</groupId>     <artifactId>spring-boot-starter-jdbc</artifactId> </dependency>  <!-- aopä¾èµ– --> <dependency>     <groupId>org.springframework.boot</groupId>     <artifactId>spring-boot-starter-aop</artifactId> </dependency>  <!-- oracleé©±åŠ¨ --> <dependency>    <groupId>com.oracle</groupId>    <artifactId>ojdbc6</artifactId>    <version>6.0</version> </dependency>  <!-- druidæ•°æ®æºé©±åŠ¨ --> <dependency>    <groupId>com.alibaba</groupId>    <artifactId>druid-spring-boot-starter</artifactId>    <version>1.1.6</version> </dependency> ```  |
| --- | --- |


<h2 id="è‡ªå®šä¹‰æ³¨è§£"><font style="color:rgb(76, 73, 72);">è‡ªå®šä¹‰æ³¨è§£</font></h2>
<font style="color:rgb(76, 73, 72);">å®šä¹‰ä¸€ä¸ªæ–¹æ³•çº§åˆ«çš„</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">@Log</font>_`<font style="color:rgb(76, 73, 72);">æ³¨è§£ï¼Œç”¨äºæ ‡æ³¨éœ€è¦ç›‘æ§çš„æ–¹æ³•ï¼š</font>

| ```plain 1 2 3 4 5 ```  | ```plain @Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) public @interface Log {     String value() default ""; } ```  |
| --- | --- |


<h2 id="åˆ›å»ºåº“è¡¨å’Œå®ä½“"><font style="color:rgb(76, 73, 72);">åˆ›å»ºåº“è¡¨å’Œå®ä½“</font></h2>
<font style="color:rgb(76, 73, 72);">åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€å¼ sys_logè¡¨ï¼Œç”¨äºä¿å­˜ç”¨æˆ·çš„æ“ä½œæ—¥å¿—ï¼Œæ•°æ®åº“é‡‡ç”¨oracle 11gï¼š</font>

| ```plain 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ```  | ```plain CREATE TABLE "SCOTT"."SYS_LOG" (    "ID" NUMBER(20) NOT NULL ,    "USERNAME" VARCHAR2(50 BYTE) NULL ,    "OPERATION" VARCHAR2(50 BYTE) NULL ,    "TIME" NUMBER(11) NULL ,    "METHOD" VARCHAR2(200 BYTE) NULL ,    "PARAMS" VARCHAR2(500 BYTE) NULL ,    "IP" VARCHAR2(64 BYTE) NULL ,    "CREATE_TIME" DATE NULL  );  COMMENT ON COLUMN "SCOTT"."SYS_LOG"."USERNAME" IS 'ç”¨æˆ·å'; COMMENT ON COLUMN "SCOTT"."SYS_LOG"."OPERATION" IS 'ç”¨æˆ·æ“ä½œ'; COMMENT ON COLUMN "SCOTT"."SYS_LOG"."TIME" IS 'å“åº”æ—¶é—´'; COMMENT ON COLUMN "SCOTT"."SYS_LOG"."METHOD" IS 'è¯·æ±‚æ–¹æ³•'; COMMENT ON COLUMN "SCOTT"."SYS_LOG"."PARAMS" IS 'è¯·æ±‚å‚æ•°'; COMMENT ON COLUMN "SCOTT"."SYS_LOG"."IP" IS 'IPåœ°å€'; COMMENT ON COLUMN "SCOTT"."SYS_LOG"."CREATE_TIME" IS 'åˆ›å»ºæ—¶é—´';  CREATE SEQUENCE seq_sys_log START WITH 1 INCREMENT BY 1; ```  |
| --- | --- |


<font style="color:rgb(76, 73, 72);">åº“è¡¨å¯¹åº”çš„å®ä½“ï¼š</font>

| ```plain 1 2 3 4 5 6 7 8 9 10 11 12 13 14 ```  | ```plain public class SysLog implements Serializable{      private static final long serialVersionUID = -6309732882044872298L;          private Integer id;     private String username;     private String operation;     private Integer time;     private String method;     private String params;     private String ip;     private Date createTime;     // get,setç•¥ } ```  |
| --- | --- |


<h2 id="ä¿å­˜æ—¥å¿—çš„æ–¹æ³•"><font style="color:rgb(76, 73, 72);">ä¿å­˜æ—¥å¿—çš„æ–¹æ³•</font></h2>
<font style="color:rgb(76, 73, 72);">ä¸ºäº†æ–¹ä¾¿ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨Spring JdbcTemplateæ¥æ“ä½œæ•°æ®åº“ã€‚å®šä¹‰ä¸€ä¸ªSysLogDaoæ¥å£ï¼ŒåŒ…å«ä¸€ä¸ªä¿å­˜æ“ä½œæ—¥å¿—çš„æŠ½è±¡æ–¹æ³•ï¼š</font>

| ```plain 1 2 3 ```  | ```plain public interface SysLogDao {     void saveSysLog(SysLog syslog); } ```  |
| --- | --- |


<font style="color:rgb(76, 73, 72);">å…¶å®ç°æ–¹æ³•ï¼š</font>

| ```plain 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ```  | ```plain @Repository public class SysLogDaoImp implements SysLogDao {      @Autowired     private JdbcTemplate jdbcTemplate;          @Override     public void saveSysLog(SysLog syslog) {         StringBuffer sql = new StringBuffer("insert into sys_log ");         sql.append("(id,username,operation,time,method,params,ip,create_time) ");         sql.append("values(seq_sys_log.nextval,:username,:operation,:time,:method,");         sql.append(":params,:ip,:createTime)");                  NamedParameterJdbcTemplate npjt = new NamedParameterJdbcTemplate(this.jdbcTemplate.getDataSource());         npjt.update(sql.toString(), new BeanPropertySqlParameterSource(syslog));     } } ```  |
| --- | --- |


<h2 id="åˆ‡é¢å’Œåˆ‡ç‚¹"><font style="color:rgb(76, 73, 72);">åˆ‡é¢å’Œåˆ‡ç‚¹</font></h2>
<font style="color:rgb(76, 73, 72);">å®šä¹‰ä¸€ä¸ªLogAspectç±»ï¼Œä½¿ç”¨</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">@Aspect</font>_`<font style="color:rgb(76, 73, 72);">æ ‡æ³¨è®©å…¶æˆä¸ºä¸€ä¸ªåˆ‡é¢ï¼Œåˆ‡ç‚¹ä¸ºä½¿ç”¨</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">@Log</font>_`<font style="color:rgb(76, 73, 72);">æ³¨è§£æ ‡æ³¨çš„æ–¹æ³•ï¼Œä½¿ç”¨</font>`_<font style="color:rgb(65, 74, 81);background-color:rgb(251, 251, 251);">@Around</font>_`<font style="color:rgb(76, 73, 72);">ç¯ç»•é€šçŸ¥ï¼š</font>

| ```plain 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 ```  | ```plain @Aspect @Component public class LogAspect {      @Autowired     private SysLogDao sysLogDao;          @Pointcut("@annotation(com.springboot.annotation.Log)")     public void pointcut() { }      @Around("pointcut()")     public Object around(ProceedingJoinPoint point) {         Object result = null;         long beginTime = System.currentTimeMillis();         try {             // æ‰§è¡Œæ–¹æ³•             result = point.proceed();         } catch (Throwable e) {             e.printStackTrace();         }         // æ‰§è¡Œæ—¶é•¿(æ¯«ç§’)         long time = System.currentTimeMillis() - beginTime;         // ä¿å­˜æ—¥å¿—         saveLog(point, time);         return result;     }  	private void saveLog(ProceedingJoinPoint joinPoint, long time) {         MethodSignature signature = (MethodSignature) joinPoint.getSignature();         Method method = signature.getMethod();         SysLog sysLog = new SysLog();         Log logAnnotation = method.getAnnotation(Log.class);         if (logAnnotation != null) {             // æ³¨è§£ä¸Šçš„æè¿°             sysLog.setOperation(logAnnotation.value());         }         // è¯·æ±‚çš„æ–¹æ³•å         String className = joinPoint.getTarget().getClass().getName();         String methodName = signature.getName();         sysLog.setMethod(className + "." + methodName + "()");         // è¯·æ±‚çš„æ–¹æ³•å‚æ•°å€¼         Object[] args = joinPoint.getArgs();         // è¯·æ±‚çš„æ–¹æ³•å‚æ•°åç§°         LocalVariableTableParameterNameDiscoverer u = new LocalVariableTableParameterNameDiscoverer();         String[] paramNames = u.getParameterNames(method);         if (args != null && paramNames != null) {             String params = "";             for (int i = 0; i < args.length; i++) {                 params += "  " + paramNames[i] + ": " + args[i];             }             sysLog.setParams(params);         }         // è·å–request         HttpServletRequest request = HttpContextUtils.getHttpServletRequest();         // è®¾ç½®IPåœ°å€         sysLog.setIp(IPUtils.getIpAddr(request));         // æ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ·å         sysLog.setUsername("mrbird");         sysLog.setTime((int) time);         sysLog.setCreateTime(new Date());         // ä¿å­˜ç³»ç»Ÿæ—¥å¿—         sysLogDao.saveSysLog(sysLog);     } } ```  |
| --- | --- |


<h2 id="æµ‹è¯•"><font style="color:rgb(76, 73, 72);">æµ‹è¯•</font></h2>
<font style="color:rgb(76, 73, 72);">TestControllerï¼š</font>

| ```plain 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 ```  | ```plain @RestController public class TestController {      @Log("æ‰§è¡Œæ–¹æ³•ä¸€")     @GetMapping("/one")     public void methodOne(String name) { }          @Log("æ‰§è¡Œæ–¹æ³•äºŒ")     @GetMapping("/two")     public void methodTwo() throws InterruptedException {         Thread.sleep(2000);     }          @Log("æ‰§è¡Œæ–¹æ³•ä¸‰")     @GetMapping("/three")     public void methodThree(String name, String age) { } } ```  |
| --- | --- |


<font style="color:rgb(76, 73, 72);">æœ€ç»ˆé¡¹ç›®ç›®å½•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</font>

![](https://cdn.nlark.com/yuque/0/2024/png/48200602/1734714003616-90eb529b-f8e4-4f15-b27f-fac62d2ead03.png)

<font style="color:rgb(76, 73, 72);">å¯åŠ¨é¡¹ç›®ï¼Œåˆ†åˆ«è®¿é—®ï¼š</font>

+ [<font style="color:rgb(76, 73, 72);">http://localhost:8080/web/one?name=KangKang</font>](http://localhost:8080/web/one?name=KangKang)
+ [<font style="color:rgb(76, 73, 72);">http://localhost:8080/web/two</font>](http://localhost:8080/web/two)
+ [<font style="color:rgb(76, 73, 72);">http://localhost:8080/web/three?name=Mike&age=25</font>](http://localhost:8080/web/three?name=Mike&age=25)

<font style="color:rgb(76, 73, 72);">æŸ¥è¯¢æ•°æ®åº“ï¼š</font>

| ```plain 1 2 3 4 5 6 7 8 9 10 11 12 ```  | ```plain SQL> select * from sys_log order by id;          ID USERNAME   OPERATION        TIME METHOD                         PARAMS                         IP         CREATE_TIME ---------- ---------- ---------- ---------- ------------------------------ ------------------------------ ---------- --------------         11 mrbird     æ‰§è¡Œæ–¹æ³•ä¸€          6 com.springboot.controller.Test  name: KangKang                127.0.0.1  08-12æœˆ-17                                             Controller.methodOne()          12 mrbird     æ‰§è¡Œæ–¹æ³•äºŒ       2000 com.springboot.controller.Test                                127.0.0.1  08-12æœˆ-17                                             Controller.methodTwo()          13 mrbird     æ‰§è¡Œæ–¹æ³•ä¸‰          0 com.springboot.controller.Test  name: Mike age: 25            127.0.0.1  08-12æœˆ-17                                             Controller.methodThree() ```  |
| --- | --- |


[<font style="color:rgb(102, 102, 102);">source code</font>](https://github.com/wuyouzhuguli/Spring-Boot-Demos/tree/master/07.Spring-Boot-AOP-Log)

<font style="color:rgb(135, 135, 135);">è¯·ä½œè€…å–ç“¶è‚¥å®…æ°´</font><font style="color:rgb(135, 135, 135);">ğŸ¥¤</font>

**<font style="color:rgb(254, 95, 85);background-color:rgb(255, 213, 190);">ï¿¥</font>**

+ **<font style="color:rgb(76, 73, 72);background-color:rgb(249, 249, 249);">æœ¬æ–‡ä½œè€…ï¼š</font>**<font style="color:rgb(76, 73, 72);background-color:rgb(249, 249, 249);"> </font><font style="color:rgb(76, 73, 72);background-color:rgb(249, 249, 249);">MrBird</font>
+ **<font style="color:rgb(76, 73, 72);background-color:rgb(249, 249, 249);">æœ¬æ–‡é“¾æ¥ï¼š</font>**<font style="color:rgb(76, 73, 72);background-color:rgb(249, 249, 249);"> </font>[<font style="color:rgb(76, 73, 72);background-color:rgb(249, 249, 249);">http://mrbird.cc/Spring-Boot-AOP log.html</font>](http://mrbird.cc/Spring-Boot-AOP%20log.html)
+ **<font style="color:rgb(76, 73, 72);background-color:rgb(249, 249, 249);">ç‰ˆæƒå£°æ˜ï¼š </font>**<font style="color:rgb(76, 73, 72);background-color:rgb(249, 249, 249);">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ </font>[<font style="color:rgb(76, 73, 72);background-color:rgb(249, 249, 249);">CC BY-NC-SA 4.0</font>](https://creativecommons.org/licenses/by-nc-sa/4.0/)<font style="color:rgb(76, 73, 72);background-color:rgb(249, 249, 249);"> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</font>

